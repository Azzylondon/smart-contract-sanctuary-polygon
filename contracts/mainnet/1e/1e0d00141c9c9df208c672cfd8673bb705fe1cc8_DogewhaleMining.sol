/**
 *Submitted for verification at polygonscan.com on 2022-04-25
*/

// SPDX-License-Identifier: MIT

/*
                                                                        ...'...                                                                                                
                                                                  .`^""""^^^^^"""""^^^^``''..                                                                                  
                                                               '":,""",,,,,,,""^^^,::;:::,"""""`.                                                                              
                                                              "::::::::::,,,,,,,,:;l;"`'''`^:;"^^^'   .`^^"`                                                                   
                                                            .`::::::;;III;I;::,Iii:'         'I;"^^"",^`''',`                                                                  
                                                          .",^",,,,,,,,,,:;II;<i<,.           .;;,"`""``^`'^,                                                                  
                                                         ";"`^,,,,,:::,,,,,,;~iii`             `>","`^,^`''`,                                                                  
                                                '^^""""^,;::,:::I!!I,:;,,,,,;~ii>^             'i,,,^`^^`''^`                                                                  
                                 '``''.        ':`''''''''''''''``^";,l,,,,,:l<i~:.            `<",,^``"`''".                                                                  
                              .^,^^^^^",,^'    .;`'`^^^^^^^``'''''`^;"l,,,,,,;~ii<;`         .`;I,,,,""""```                                                                   
                             `,^^^^``'.''^":'   `:```````^""""^`''`";,I,,,,,,,;<<i>iI"`''''`"IiI,,,,,,,,,,"^^``'                                                               
                           .,^^^^`..'`",,,,,;    ',`'''''''`""""``^;";,,,,,,,,,:I><<>><~~<<>iI:::::::,,"""^^^":;"                                                              
                          `"^^^`'.`",:,,,,:,".    ."``'''''`""```,;,;:,,,,,,,,,,,:;:::III;II;;;;;;;;;;;;;;;;;;;;"                                                              
                         `^^^^`.`"::,,::^'          `"''''`"^``^:,,;,,,,,,,,,,::,":;II;;;;;:,""^^^^"`^lxl'~,;il^.                                                              
                        `^^^^''"::,,,`.             '!,`'`^``^::,:,,,,,,,,,,,,"";lI;;;;,,"^```'''`'"z+1&`^[`'```^"^.                                                           
                       `^^^^``::,,`.                .l;:""",,::;I:,,,,,,"""",:Il;;I:,^``'`^`''''''``^l~:;"`'''.....,,..                                                        
               .'     '"^^^^":,,'                   .!;:::;;II;;;;IIIIIIIIII;;;Il,|*1',W`'-^''''''......^,;I:^.. .`."^....                                                     
              >+~_,^""",,,"","'                      ;;,,;;;;;I;,,,",,:;IIII;,"``^`;<<,.^?,`''''.... `~(\///tvf`.`''',.                                                        
              ':_i^.^^^^^",,'                        ^II;;;l;"^^``''``'`````'''''``,:;li"`'``^`'. ..')\jB$ctM$vl"`''', ...                                                     
                `:^..`^,,:,,.                        `l;;;;"^^````'''''''..........'''```^^^``''``^"^"{t#Wutfx}`'''.."                                                         
                ^,,"",;;<i;:.                       .!;;;l^^^``'''''''''..................'''..'''``^^`,+{()|;'''`'..^                                                         
               `,::,,I,>-+~i`.                      .l;;;>,^^`'''''''''............. ...... .`'....'''''''''l"^"`'...`                                                         
             .^^^^^":I:,""l_+~,'                     ."I;Il,^`'''''''''.................''''`...''''`^""""::"^^`... '.                                                         
            '^^`'^^,,`     .:-_<>".                     .. ',`''`''''''' ...............'````^^^^"""`''''''''.......'                                                          
           `^^`.`",,'         ^<-_+l`.                      ^`''''''''''.....................''''''''''........... ..                                                          
          `^^`.',,,.            'I]__<:'                    .^''''''''''...................... ...... . ............                                                           
         `^^`.',,,'               ."_+<~<".                  "`''''''''''.........................................'''.'''````'.                                                
        ."^^.',::'                   `!-++_!`              .."''''''''''''....................................  .``""`''''''''`^^`'                                            
        "^^'.";,`                      .:?i,","'          .^`^'''''''''''''.. .................................'``"`''''''''''''''`"^.                                         
       .,^^.`;,,                         i`'''`"l^.       ```^`'''''''''''`'..................................```"`'''''`'''''''''''`"".                                       
       ^^^`.:::'                        .I'''''':<~;,`````"```^^`''''''''''................................'`^``""''''''''''''''''''''`:                                       
       :^^.`;,,                          !'''''',?_<~+l"^^,`````^^``''''..   ...  ......... ....  . .....`^````^^^`''''''''''''''''''`':.                                      
       ;^^.";:'                          ,^''''`^!_}-~~_<I,````````^^`.      ..     ....     ..     .'`^^``````"^``''''''''''''''''''``;                                       
       :^^',,;                           .;`''''`"^,i[?_~+_!,````````^^`'    ..      ..      ....'`^^^`````````"^`'''''''``'''''''''''"`                                       
       ""^':,,                            .,`''''``^^^;?[+~+_+;^`````````^^^```      .'''``^^""^```````````````^^``''''`'``'`'''''''`,,                                        
       .,^`:,"                              ^`'''''``^^^,-}-?++_i,```````````^"       `,````````````````````````"^``'''`````'''''''`^"",,`                                     
        ,^`,,"                               .``''`''```^:"l][-~~++I^````````^^   .   .:^```````````````````````^"^```''``"""````'``'''`""     .''                             
        .:^":,                                  '``''''`,"```,_}?_+<+<:^`````^^   ...  ,"`````````````````````````^^^""""^```^"^``````^:l.   .,^``,`                           
         ^,^:I                                    .''`^":^`````"l]]?+~+_l,```^^   ..   `,``````````````````````````````````````^"""",,"^"   ',`''''^:                          
          "",;'                                       .,^`````````,+[?_~<__:`^^   ..   .:`````````````````````````````````````````````^^   ','''''''^:                         
           ^,,;                                       ""````````````"i[?[]]_`^"   ..    ,^```````````````````````````````````````````^'   .,'''''''``:^                        
            `::^                                     `,````````````````:<i;^`^,  ...    `"```````````````````````````````````````````     "''''''''''`<.                       
             ';I.                                   ':````````````````````````,  ...    ',`````````````````````````````````````````'     ."''''''''''`!'                       
               ^!.                                  ""````````````````````````,   ..    .;``````````````````````````````````````^``'`'   .^'''`''''`^,l:,,",,"""^`'.           
                ."'                                 ^,````````````````````````,.  ..     :^``````````````````````````````````^^``'''''`..'"''''''''`'''''''''''''`^,;,'        
                  .                                 .""```````````````````````^`  ..     ,^````````````````````````````````^^``''''''''^```''''''''`'''''''''''''''''`,I'      
                                                      .^,^`````````````````````"  .      ""````````````````````````````^"^^`'''''''''''`^'''''''''''''''''''''`''''''''`+.     
                                                         '`^"^`````````````````"'   .    ""````````````````````````^""^``''''''''''''''```''''''''''''''''''''''''''''`:;.     
                                                             .``^^``````````````,' ..    ,^```````````````````^"""^``'''''''''''''''''''''''''`^`''''''''''''''''''`,;".       
                                                                  .''``^`````````"' ..  .;^^`````````^^""""^^^^``'''''''''''''''''''''''''`'`"!:l"`'''''''''''``":;"'          
                                                                        ...''''''.   ..  .''```````''''..... .''''''''''''''''''''''''`'''^:;`  .`",:::,,,:::,,^'.             
                                                                           ..  .       .      ..           ....''''''''''''''''''''''''`,I".           ...                     
                                                                            ....        .       .           .  .'''''''''''''''''''``,;"'                                      
                                                                               ''.                ..          ....'''''''''''''''`,;"'                                         
                                                                                 .''                 .             ..'''''''``":,`.                                            
                                                                                    '''.      .         ..             ..`,:,^.                                                
                                                                                       .'''..   .                  .'`"""`.                                                    
                                                                                           ..''``````'''''''```^^^^`'.                                                         
                                                                                                     ......                                                                    


                                                                        DOGEWHALE MINING OPERATIONS v1.0          
                                                                    grab that pick and get to work woobly boi
                                                                                    PUMP ET!

by DeFi LABS
*/

pragma solidity ^0.8.7;

abstract contract Initializable {
    bool private _initialized;
    bool private _initializing;
    modifier initializer() {
        require(_initializing || !_initialized, "Initializable: contract is already initialized");

        bool isTopLevelCall = !_initializing;
        if (isTopLevelCall) {
            _initializing = true;
            _initialized = true;
        }

        _;

        if (isTopLevelCall) {
            _initializing = false;
        }
    }
}

abstract contract Context {
    function _msgSender() internal view virtual returns (address) {
        return msg.sender;
    }

    function _msgData() internal view virtual returns (bytes calldata) {
        return msg.data;
    }
}

interface IERC20 {
    function totalSupply() external view returns (uint256);
    function balanceOf(address account) external view returns (uint256);
    function transfer(address recipient, uint256 amount) external returns (bool);
    function allowance(address owner, address spender) external view returns (uint256);
    function approve(address spender, uint256 amount) external returns (bool);
    function transferFrom(address sender, address recipient, uint256 amount) external returns (bool);
    function decimals() external view returns (uint256);
}

contract DogewhaleMining is Initializable, Context {

    mapping(address => bool) public abuser;             //blacklist control for possible abusers
    mapping(address => uint256) public wenLastMined;    //timestamp of the last mined dogewhale
    uint256 public cooldown;                            //cooldown period before mining again to prevent attacks

    address public dogewhale_contract;                  //dogewhale token contract address
    uint256 public reward_upper_limit;                  //reward can't exceed the amount in the upper limit
    uint256 public reward_standard;                     //a standard predictable mining reward
    uint256 public reward_extra;                        //a more generous reward

    //permissions
    address public deployer;
    address public ge_contract;                         //no longer in use in favor of 'isFromGE' mapping variable

    //mining records
    mapping(address => uint256) public howMuchMined;    //shows how much an address has mined

    //state of mining
    bool public isMiningActive;                         //toggles mining on/off
    string public version;                              //miner version control for updates
    string public downloadLink;                         //ipfs download link for decentralized desktop mining

    //mining gas
    uint256 public miningGas;                           //gas limit used for mining

    //support token
    address public supportToken;                        //alternative token
    bool public isSupportTokenActive;                   //toggle to start/stop sending an alternative token
    uint256 public supportTokenStandardReward;          //standard reward for support token

    //control variables                                 //default: slow
    int256 public topOfCurve = 50;                      //curve tops out at 100 for 100%, default: 50
    int256 public inflection = 200;                     //inflection                    , default: 200
    uint256 public steep = 500;                         //curve steepness               , default: 500

    //more ge_wallets (mapping to replace ge_contract)
    mapping(address => bool) public isFromGE;

    function init() external initializer {
        cooldown = 5;
        reward_standard = 5;
        reward_extra = 15;
        dogewhale_contract = 0xf07F6AFbeeb5e0378cE29D7dFa5E252FBd1D7B6b;    //wrapped dogewhale on Polygon Chain
        deployer = 0x16f7c37FF84a71a8be7EB24228Cdc8E438D12060;
    }

    /////////////////////////////////////////////////////////////////////////////////////////////////
    // ADMIN FUNCTIONS =============================================================================>
    /////////////////////////////////////////////////////////////////////////////////////////////////

    function toggleFromGE(address _ge_contract) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        if (isFromGE[_ge_contract] == true) {
            isFromGE[_ge_contract] = false;
        } else {
            isFromGE[_ge_contract] = true;
        }
        return true;
    }

    function setGEContract(address _ge_contract) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        ge_contract = _ge_contract;
        return true;
    }

    function setRewardUpperLimit(uint256 _upperLim) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        reward_upper_limit = _upperLim;
        return true;
    }

    function setRewards(uint256 _standardReward, uint256 _extraReward) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        reward_standard = _standardReward;
        reward_extra = _extraReward;
        return true;
    }

    function setCooldown(uint256 _seconds) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        cooldown = _seconds;
        return true;
    }

    function toggleAbuser(address _abuser) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        if (abuser[_abuser] == false) {
            abuser[_abuser] = true;
        } else {
            abuser[_abuser] = false;
        }
        return true;
    }

    function toggleMiningActive() public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        if (isMiningActive == false) {
            isMiningActive = true;
        } else {
            isMiningActive = false;
        }
        return true;
    }

    function setVersion(string memory _version) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        version = _version;
        return true;
    }

    function setDownloadLink(string memory _dLink) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        downloadLink = _dLink;
        return true;
    }

    function setMiningGas(uint256 _miningGas) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        miningGas = _miningGas;
        return true;
    }

    function setAltToken(address _altToken) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        supportToken = _altToken;
        return true;
    }

    function toggleSupportToken() public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        if (isSupportTokenActive == false) {
            isSupportTokenActive = true;
        } else {
            isSupportTokenActive = false;
        }
        return true;
    }

    function setSupportTokenReward(uint256 _supportTokenReward) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        supportTokenStandardReward = _supportTokenReward;
        return true;
    }

    function setS_CurveParams(int256 _topOfCurve, int256 _inflection, uint256 _steep) public virtual returns (bool) {
        require(_msgSender() == deployer, "Unauthorized");
        topOfCurve = _topOfCurve;
        inflection = _inflection;
        steep = _steep;
        return true;
    }

    /////////////////////////////////////////////////////////////////////////////////////////////////
    // CONTROL FUNCTIONS ===========================================================================>
    /////////////////////////////////////////////////////////////////////////////////////////////////

    function calcTime(int256 _minerTime) internal virtual returns (uint256) {
        //curve type:       S-Curve
        //curve profile:    https://www.desmos.com/calculator/nocyfndoqj
        //curve function:   a ((x - b)/sqrt(c + (x - b)^2) + 1)

        int256 XminusB = sub(_minerTime, inflection);
        int256 over = mul(topOfCurve, XminusB);
        uint256 under = uint256((XminusB)**2) + steep;
        uint256 result = uint(div(over, int256(sqrt(under))) + topOfCurve);

        return result;
    }

    function selfBan(address _abuser) public virtual returns (bool) {
        require(isFromGE[_msgSender()]==true, "Unable");
        abuser[_abuser] = true;
        return true;
    }

    function identCheat(address _wallet) public virtual returns (bool) {
        require(isFromGE[_msgSender()]==true, "Unable");
        return true;
    }

    /////////////////////////////////////////////////////////////////////////////////////////////////
    // MINING REWARD FUNCTIONS =====================================================================>
    /////////////////////////////////////////////////////////////////////////////////////////////////

    function rewardMinerStandard(address _minerAddy) public virtual returns (bool) {
        require(isFromGE[_msgSender()]==true, "Unauthorized");
        require(abuser[_minerAddy] == false);
        require(block.timestamp > wenLastMined[_minerAddy]+cooldown, "Easy fella");
        require(isMiningActive == true, "Mining is off");

        if (wenLastMined[_minerAddy] != 0) {
            uint256 minerPct = calcTime(int256(block.timestamp-wenLastMined[_minerAddy]));
            uint256 rewardAmount = _pct(reward_standard, minerPct)*10**16;
            IERC20(dogewhale_contract).transfer(_minerAddy, rewardAmount);
            howMuchMined[_minerAddy] += rewardAmount;
            
            if (isSupportTokenActive == true) {
                IERC20(supportToken).transfer(_minerAddy, _pct(supportTokenStandardReward, minerPct)*10**16);
            }
        } else {
            IERC20(dogewhale_contract).transfer(_minerAddy, reward_standard);
            howMuchMined[_minerAddy] += reward_standard;
            
            if (isSupportTokenActive == true) {
                IERC20(supportToken).transfer(_minerAddy, supportTokenStandardReward);
            }
        }
        
        wenLastMined[_minerAddy] = block.timestamp;
        return true;
    }

    /*
    function rewardMinerExtra(address _minerAddy) public virtual returns (bool) {
        require(isFromGE[_msgSender()]==true, "Unauthorized");
        require(abuser[_minerAddy] == false);
        require(block.timestamp > wenLastMined[_minerAddy]+cooldown, "Easy fella");
        require(isMiningActive == true, "Mining is off");

        IERC20(dogewhale_contract).transfer(_minerAddy, reward_extra);
        wenLastMined[_minerAddy] = block.timestamp;
        howMuchMined[_minerAddy] += reward_extra;
        return true;
    }

    function rewardMinerDynamic(address _minerAddy, uint256 _reward) public virtual returns (bool) {
        require(isFromGE[_msgSender()]==true, "Unauthorized");
        require(_reward > 0 , "No zero reward");
        require(_reward <= reward_upper_limit, "Out of bounds");
        require(abuser[_minerAddy] == false);
        require(block.timestamp > wenLastMined[_minerAddy]+cooldown, "Easy fella");
        require(isMiningActive == true, "Mining is off");

        IERC20(dogewhale_contract).transfer(_minerAddy, _reward);
        wenLastMined[_minerAddy] = block.timestamp;
        howMuchMined[_minerAddy] += _reward;
        return true;
    }
    */

    /////////////////////////////////////////////////////////////////////////////////////////////////
    // MATH FUNCTIONS ==============================================================================>
    /////////////////////////////////////////////////////////////////////////////////////////////////
    
    function sub(int256 a, int256 b) internal pure returns (int256) {
        int256 c = a - b;
        return c;
    }

    function mul(int256 a, int256 b) internal pure returns (int256) {
        return a * b;
    }

    function div(int256 a, int256 b) internal pure returns (int256) {
        return a / b;
    }

    function sqrt(uint x) internal pure returns (uint y) {
        uint z = (x + 1) / 2;
        y = x;
        while (z < y) {
            y = z;
            z = (x / z + z) / 2;
        }
    }

    function _pct(uint _value, uint _percentageOf) internal virtual returns (uint256 res) {
        res = (_value * _percentageOf) / 10 ** 18;
    }

}