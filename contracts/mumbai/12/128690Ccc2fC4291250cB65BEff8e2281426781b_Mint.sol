//SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;
import "@openzeppelin/contracts/utils/math/SafeMath.sol"; //Safemath no longer needed Sol v0.8.0 onwards
import "@openzeppelin/contracts/utils/Strings.sol";
import "@openzeppelin/contracts/token/ERC1155/ERC1155.sol";

contract Mint is ERC1155{

    using SafeMath for uint256;
    using Strings for string;

    uint256[] private batchMintids_;
    uint256 private royaltyFee = 5 ; // 5% royalty fee
    address public  devAddress; //payable?
    address public   beneficiary; //payable?
    uint mintEndTime;
    uint EXPIRY= 365 days;
    uint public immutable startedAt;
    uint internal timeElapsed;
    // uint DURATION = 10 days;
    address payable public owner;

    event NFTReservesUpdated(uint256 idx, uint256 amount);
    event WithdrawEvent(address account,uint256 amount);

    error ErrorNFTReserves();
    event TokenURIChanged(string URI_,uint256 _tokenId);
    event AddressesSet(address beneficiary,address devAddress);
    error Unauthorized();
    error AuctionAlreadyEnded();
    error FunctionInvalidAtThisStage();

    error InvalidAddress();
    error InvalidExpiryDate();
    error NothingToWithdraw();
    error OwnerCannotParticipate();
    error BeneficiaryCannotParticipate();
    error DevCannotParticipate();
    error InvalidTransaction();
    string public baseExtension = ".json";
    string private _baseURI=  "https://ipfs.io/ipfs/QmcDRWwXCE1LjvdESNZsmc75syTJP2zA8WW9SHEaCwEmkc/";


    // uint256[]  ids= [46,93,99,27];
    // uint256[]  prices = [1 ether, 0.5 ether, 0.5 ether, 0.5 ether];
    // // ["1000000000000000000","500000000000000000","500000000000000000","500000000000000000"]
    // uint256[]  maxAmounts= [1000,500,400,300];
    // uint256 private maxMintAmount = 100;
    // uint dutchEndPrice = 0.1 ether;
    // uint dutchStartPrice= 5 ether;
    // // "5000000000000000000"
    // uint DURATION = 200 seconds;
    // uint dutchDiscountRate = 10000000000000000;

    uint256[]  ids;
        //= [46,93,99,27];
    uint256[]  prices;
    // = [1 ether, 0.5 ether, 0.5 ether, 0.5 ether];
    // ["1000000000000000000","500000000000000000","500000000000000000","500000000000000000"]
    uint256[]  maxAmounts;
    //= [1000,500,400,300];
    uint256 private maxMintAmount;
    // = 100;


//Dutch Auction variables 
    uint DURATION;// = 200 seconds;
    uint dutchEndPrice;// = 0.1 ether;
    uint dutchStartPrice;//= 5 ether;
    uint dutchDiscountRate;// = 10000000000000000;
    uint auctionEndTime;

// for 10 days 5000000000000 * 864000 = 3.45e18
//for 200 secs 10000000000000000 * 200 = 4e18

    struct NFTInfo {
        uint256 id;
        uint256 price;
        uint256 reserves;
        }

    NFTInfo[] internal nftInfo;



    struct MintVariables {
        uint idx;
        uint id;
        uint price;
        uint reserves;
        uint amount;
        uint totalPrice;
        uint beneficiaryAmount;
        uint devAmount;
    }

    MintVariables  m_vars;
    mapping (uint256 => uint256) internal _idToidx; //TokenId to Index position mapping
    mapping (uint256=>  string) _tokenURI; //TokenId to tokenURI mapping
    mapping (address => uint256) public pendingWithdrawal;// withdraw later

constructor  (
            uint256[] memory ids_,
            uint256[] memory prices_, 
            uint256[] memory maxAmounts_,
            // uint256 royaltyFee_,
            uint256 maxMintAmount_,
            uint dutchStartPrice_,
            uint dutchDiscountRate_,
            uint DURATION_
             )ERC1155(_baseURI) payable {
        owner = payable(msg.sender);
        startedAt = block.timestamp;                                                                   
        // auctionEndTime = startedAt + DURATION;
        mintEndTime = block.timestamp + EXPIRY; 


        require(ids_.length == maxAmounts_.length && ids_.length == prices_.length,"ERC1155: Input array lenghts aren't the same!");
        ids = ids_;
        prices = prices_;
        maxAmounts = maxAmounts_;

               for(uint i =0; i< ids.length; i++) {
            _idToidx[ids[i]] = i;
            nftInfo.push(NFTInfo({
            id: ids[i],
            price: prices[i],
            reserves: maxAmounts[i]
                  }));
            _tokenURI[ids[i]] = string.concat(_baseURI,Strings.toString(ids[i]),baseExtension);
        }
        maxMintAmount = maxMintAmount_;    
        DURATION = DURATION_;
        auctionEndTime = startedAt + DURATION;
        dutchStartPrice = dutchStartPrice_;
        dutchDiscountRate = dutchDiscountRate_;
        require(dutchStartPrice > getDiscount(dutchDiscountRate,DURATION),"Starting price is too low!");

    }


    //No Reentrance Guard
    bool locked;
    modifier noReentrancy(){
        require(!locked,"Reentrant Call");
        locked = true;
        _;
        locked = false;
        _;

    }

    enum MintStage {
        MintLive,
        MintEnded
    }

    MintStage mintStage;
    //OnlyOwner Modifier
    modifier onlyBy(address account){
        if (msg.sender != account) revert Unauthorized();
        _;
    }


    modifier mintTimedTransitions() {
        if (block.timestamp > mintEndTime)
            nextMintStage();
            _;
    }


    modifier atMintStage(MintStage mintStage_) {
        if (mintStage != mintStage_) revert FunctionInvalidAtThisStage();
        _;

    }
   

    function nextMintStage() internal {
        mintStage = MintStage(uint(mintStage)+1);
    }

 //-------------------------
//MINT SINGLE : START 

       function mintSingle(uint256 _id, uint256 _amount)  
         public   
         payable 
         mintTimedTransitions() 
         atMintStage(MintStage.MintLive){
       if (msg.sender == address(0)) revert InvalidAddress();
        require(_amount<= maxMintAmount && balanceOf(msg.sender,_id) <= maxMintAmount,"There's a limit to minting per address");
        // require(msg.sender != owner || msg.sender != beneficiary || msg.sender != devAddress,"Owner, beneficiary and devs cannot bid on this auction");
         if (msg.sender == owner) revert OwnerCannotParticipate();
         if (msg.sender == beneficiary) revert BeneficiaryCannotParticipate();
         if (msg.sender == devAddress) revert DevCannotParticipate();

        uint256 _idx;
        _idx =  _idToidx[_id];
        uint256 price;
       uint256 royaltyFees;
       uint256 beneficiaryAmount;
       uint256 nftReserves;

       price = nftInfo[_idx].price;
      nftReserves = nftInfo[_idx].reserves;
  
        require( nftReserves >= _amount,"ERC1155: Sorry, this NFT's sold out!");
        // require(  price*_amount<= msg.value,"ERC1155: You don't have enough funds for this single mint");
        if( msg.value< price*_amount) revert InvalidTransaction();
        // "ERC1155: You don't have enough funds for this batch mint");


        //Update NFT Reserves
        _updateReserves(_idx,_amount);

       //Mint to the calling account address
        _mint(msg.sender,_id,_amount,""); //Will update the user balances and enumerations

        //Calculate and Pay Royalty Fee to owner/platform
         royaltyFees = (msg.value*royaltyFee)/100;

        //Owner withdraws the balance funds
        beneficiaryAmount = msg.value-royaltyFees;

        //Using the pendingWithdrawal method
        pendingWithdrawal[devAddress] = royaltyFees;
        pendingWithdrawal[beneficiary] = beneficiaryAmount;

    }
//***/
//----------------

// /MINT BATCH : START 
    function mintBatch(uint256[] memory _ids, uint256[] memory _amounts) 
    public    
    payable 
    mintTimedTransitions() 
    atMintStage(MintStage.MintLive)
    returns (uint,uint){

        if (msg.sender == address(0)) revert InvalidAddress();
         if (msg.sender == owner) revert OwnerCannotParticipate();
         if (msg.sender == beneficiary) revert BeneficiaryCannotParticipate();
         if (msg.sender == devAddress) revert DevCannotParticipate();       
        //   require(_ids.length == _amounts.length,"ERC1155: Invalid array lengths");
        
       m_vars.totalPrice = 0;
       
        // NFTInfo memory nftInfo_;

        for(uint i =0; i< _ids.length; i++) {
        m_vars.idx =  _idToidx[_ids[i]];
        m_vars.id = _ids[i];
        m_vars.price = nftInfo[m_vars.idx].price;
        m_vars.reserves = nftInfo[m_vars.idx].reserves;
        m_vars.amount = _amounts[i];
        require(m_vars.reserves >= m_vars.amount,
        "ERC1155: Not enough NFTs of this tokenId in stock!");
        require(m_vars.amount<= maxMintAmount 
         && balanceOf(msg.sender,m_vars.id) <= maxMintAmount,
         "There's a limit to minting per address");
        //     // require( msg.value>= price*amount,"ERC1155: You don't have enough funds for this batch mint");
        //     //  if( msg.value < m_vars.price*m_vars.amount) revert InvalidTransaction();

        //     //Update NFT reserves for the selcted token
        
        _updateReserves(m_vars.idx,m_vars.amount);
        //   //Calculate the cumulative platform fees per token/amount
        // //Calculate total owner payments for the batch mint

            mintSingle(m_vars.id,m_vars.amount);
        m_vars.totalPrice= m_vars.totalPrice+ (m_vars.price*m_vars.amount);

        }

         if( msg.value < m_vars.totalPrice) revert InvalidTransaction();

     
        //Using the pendingWithdrawal method
        m_vars.devAmount = (m_vars.totalPrice*royaltyFee)/100;
        m_vars.beneficiaryAmount = m_vars.totalPrice - m_vars.devAmount;

        pendingWithdrawal[devAddress] = m_vars.devAmount;
        pendingWithdrawal[beneficiary] =  m_vars.beneficiaryAmount;  
        return ( msg.value, m_vars.totalPrice);
    }




    function getElapsedTime() public 
        view
        onlyBy(owner) 
        returns (uint) 
    {
        return block.timestamp-startedAt;
    }


    function currentBlockStamp() public view returns (uint) {
        return block.timestamp;
    }

   

    //ERC1155: Returns the tokenURI of TokenId
    function uri(uint256 id) override public view returns (string memory) {
        require (bytes(_tokenURI[id]).length !=0, "This token doesn't exist!");
        return _tokenURI[id];
    }


    //ERC1155: Change the tokenURI if needed on a per token basis
    function setTokenURI(string memory baseURI_,uint256 id) public onlyBy(owner) {
        _tokenURI[id] = string.concat(baseURI_,Strings.toString(id),baseExtension);
        emit TokenURIChanged(_tokenURI[id],id);
    }

    function getNFTInfo(uint tokenId) public view returns (NFTInfo memory) {
        require (bytes(_tokenURI[tokenId]).length !=0, "This token doesn't exist!");
        uint idx_ = _idToidx[tokenId];
        return nftInfo[idx_];
}   

    function _updateReserves(uint256 _idx,uint256 amount) internal {
        if (nftInfo[_idx].reserves < amount) revert ErrorNFTReserves();
        nftInfo[_idx].reserves -= amount;
        emit NFTReservesUpdated(_idx, amount);
    }


function withdraw() external payable noReentrancy {
        uint256 amount = pendingWithdrawal[msg.sender];
        // if (amount <=0) revert NothingToWithdraw();

        pendingWithdrawal[msg.sender] = 0;
        // payable(msg.sender).transfer(amount);
        //Since the transfer method is no longer safe to use due to gas cost fluctiation, only sends 2300 gas
        //Call forwards all the gas, risk of reentrance attack, so use reentrance guard modifier
        (bool success2,) = payable(msg.sender).call{value: amount}("");
        require(success2,"Owner payment transaction failed!");

    emit WithdrawEvent(msg.sender,amount);

    }


    function getPendingBalance(address addr_) public view returns (uint) 
    {return pendingWithdrawal[addr_];}

function setAddresses(address payable beneficiaryAddr_, address payable devAddress_)
    public 
    onlyBy(owner)  
    {
        beneficiary = beneficiaryAddr_;
        devAddress = devAddress_;
        emit AddressesSet(beneficiary, devAddress);
    }



function getAddresses() public view onlyBy(owner) returns (address,address){
    return (beneficiary,devAddress);
}


//----
//DUTCH auction start

//ERC1155 Mint variables 
    enum DutchStage {
        DutchAuctionLive,
        DutchAuctionEnded
    }

    DutchStage dutchStage;

    struct Payments {
        uint price;
        uint balance;
        uint refund;
        uint devPayment;
        uint ownerPayment;}

    mapping (uint => Payments) dutchAuctionInfo;

 Payments payment;


    modifier dutchTimedTransitions() {
        if (block.timestamp > auctionEndTime)
            nextDutchStage();
            _;
    }


    modifier atDutchStage(DutchStage dutchStage_) {
        if (dutchStage != dutchStage_) revert FunctionInvalidAtThisStage();
        _;

    }

    function nextDutchStage() internal {
        dutchStage = DutchStage(uint(dutchStage)+1);
    }

 //-------------------------
//DUTCH AUCTION: START 

 function bid(uint256 tokenId) 
        external 
        payable 
        dutchTimedTransitions()
        atDutchStage(DutchStage.DutchAuctionLive) 
           returns (uint, uint,uint,uint,uint)
        {
    //    if (msg.sender == address(0)) revert InvalidAddress();
       if (block.timestamp > auctionEndTime) revert AuctionAlreadyEnded();
        require(msg.sender != owner && msg.sender != beneficiary && msg.sender != devAddress,"Owner, beneficiary and devs cannot bid on this auction");
        uint256 _idx;
        _idx =  _idToidx[tokenId];
        dutchAuctionInfo[tokenId].price = dutchStartPrice - dutchDiscountRate*(block.timestamp-startedAt);

       require  (msg.value >=  dutchAuctionInfo[tokenId].price,"Bid not high enough!");
        _updateReserves(_idx,1); //Subtract 1, as we only have 1 of this NFT
      _mint(msg.sender,tokenId,1,""); // //1:1 NFT minted
    // emit Sold(tokenId, msg.sender);

    // //Refund the balance and emit an event
     if (msg.value> dutchAuctionInfo[tokenId].price) 
        {dutchAuctionInfo[tokenId].refund = msg.value - dutchAuctionInfo[tokenId].price;
        pendingWithdrawal[msg.sender] +=dutchAuctionInfo[tokenId].refund;}
        
    //     //Calculate balanceAmount and Pay Royalty and Owner Fees
        dutchAuctionInfo[tokenId].balance = msg.value - dutchAuctionInfo[tokenId].refund;
        dutchAuctionInfo[tokenId].devPayment = (dutchAuctionInfo[tokenId].balance 
                                                *(royaltyFee)/100);
        dutchAuctionInfo[tokenId].ownerPayment = dutchAuctionInfo[tokenId].balance
                                                    - dutchAuctionInfo[tokenId].devPayment;
    //    //Using the pendingWithdrawal method

        pendingWithdrawal[devAddress] = dutchAuctionInfo[tokenId].devPayment;
        pendingWithdrawal[beneficiary] = dutchAuctionInfo[tokenId].ownerPayment;

        // return (tokenId,msg.value,dutchAuctionInfo[tokenId].price);
        return (tokenId,
                msg.value,
                pendingWithdrawal[msg.sender],
                pendingWithdrawal[devAddress],
                pendingWithdrawal[beneficiary]);
 }


    // function getDiscount() internal view returns (uint) {
    //     return dutchDiscountRate * DURATION_;
    // }

    function getDiscount(uint dutchDiscountRate_,uint DURATION_) 
        internal 
        pure  
        returns (uint) {
        return dutchDiscountRate_ * DURATION_;
    }


    function getDutchPrice() 
        public 
        onlyBy(owner)
        view 
        returns(uint) {

        return dutchStartPrice - (dutchDiscountRate*getElapsedTime());
    }


function getAuctionEndTime()
    public 
    view
    onlyBy(owner)
    returns (uint) {
        return auctionEndTime;
    }

    //----


}




//Compiled byte code

// 0x6080604052600436106101b8576000357c01000000000000000000000000000000000000000000000000000000009004806351d550d211610109578063c6682862116100a7578063d351cfdc11610081578063d351cfdc1461050b578063e985e9c514610533578063f21f537d1461057c578063f242432a146105b057600080fd5b8063c6682862146104a1578063c7095185146104b6578063d188929f146104c957600080fd5b80638da5cb5b116100e35780638da5cb5b1461040c57806390107afe1461042c578063a22cb4651461044c578063a39fac121461046c57600080fd5b806351d550d2146103ac578063787c0a6c146103e257806380d7c5ec146103f757600080fd5b80632eb2c2d6116101765780633ccfd60b116101505780633ccfd60b14610329578063454a2ab3146103315780634dd74aac1461036c5780634e1273f41461037f57600080fd5b80632eb2c2d6146102b157806338af3eed146102d15780633ad10ef61461030957600080fd5b8062fdd58e146101bd57806301ffc9a7146101f05780630964c95b1461022057806309a3beef1461024d5780630e89341c1461026f578063125d70201461029c575b600080fd5b3480156101c957600080fd5b506101dd6101d836600461276b565b6105d0565b6040519081526020015b60405180910390f35b3480156101fc57600080fd5b5061021061020b3660046127ad565b61067c565b60405190151581526020016101e7565b34801561022c57600080fd5b506101dd61023b3660046127d1565b60216020526000908152604090205481565b34801561025957600080fd5b5061026d610268366004612892565b610719565b005b34801561027b57600080fd5b5061028f61028a3660046128eb565b6107df565b6040516101e79190612960565b3480156102a857600080fd5b506101dd6108ec565b3480156102bd57600080fd5b5061026d6102cc366004612a25565b61094e565b3480156102dd57600080fd5b506006546102f190600160a060020a031681565b604051600160a060020a0390911681526020016101e7565b34801561031557600080fd5b506005546102f190600160a060020a031681565b61026d6109f3565b61034461033f3660046128eb565b610bd5565b604080519586526020860194909452928401919091526060830152608082015260a0016101e7565b34801561037857600080fd5b50426101dd565b34801561038b57600080fd5b5061039f61039a366004612ad3565b610f5e565b6040516101e79190612bd8565b3480156103b857600080fd5b506101dd6103c73660046127d1565b600160a060020a031660009081526021602052604090205490565b3480156103ee57600080fd5b506101dd61109f565b34801561040357600080fd5b506101dd6110d8565b34801561041857600080fd5b50600a546102f190600160a060020a031681565b34801561043857600080fd5b5061026d610447366004612beb565b61112b565b34801561045857600080fd5b5061026d610467366004612c24565b6111cd565b34801561047857600080fd5b506104816111dc565b60408051600160a060020a039384168152929091166020830152016101e7565b3480156104ad57600080fd5b5061028f611229565b61026d6104c4366004612c57565b6112b7565b3480156104d557600080fd5b506104e96104e43660046128eb565b61160a565b60408051825181526020808401519082015291810151908201526060016101e7565b61051e610519366004612c79565b6116fc565b604080519283526020830191909152016101e7565b34801561053f57600080fd5b5061021061054e366004612beb565b600160a060020a03918216600090815260016020908152604080832093909416825291909152205460ff1690565b34801561058857600080fd5b506101dd7f00000000000000000000000000000000000000000000000000000000629e625381565b3480156105bc57600080fd5b5061026d6105cb366004612cc6565b611b17565b6000600160a060020a0383166106565760405160e560020a62461bcd02815260206004820152602b60248201527f455243313135353a2062616c616e636520717565727920666f7220746865207a60448201527f65726f206164647265737300000000000000000000000000000000000000000060648201526084015b60405180910390fd5b50600090815260208181526040808320600160a060020a03949094168352929052205490565b6000600160e060020a031982167fd9b67a260000000000000000000000000000000000000000000000000000000014806106df5750600160e060020a031982167f0e89341c00000000000000000000000000000000000000000000000000000000145b8061071357507f01ffc9a700000000000000000000000000000000000000000000000000000000600160e060020a03198316145b92915050565b600a54600160a060020a03163381146107475760405160e860020a6282b42902815260040160405180910390fd5b8261075183611bb5565b600b60405160200161076593929190612d6c565b60408051601f19818403018152918152600084815260208080529190208251610793939192909101906126c3565b5060008281526020805260409081902090517faa9103d5d6eea4f6c7e86c99d53cf3a0a3f1fc853a138aa8117c61ec695bf526916107d2918590612e08565b60405180910390a1505050565b600081815260208052604090208054606091906107fb90612d2f565b905060000361084f5760405160e560020a62461bcd02815260206004820152601960248201527f5468697320746f6b656e20646f65736e27742065786973742100000000000000604482015260640161064d565b60008281526020805260409020805461086790612d2f565b80601f016020809104026020016040519081016040528092919081815260200182805461089390612d2f565b80156108e05780601f106108b5576101008083540402835291602001916108e0565b820191906000526020600020905b8154815290600101906020018083116108c357829003601f168201915b50505050509050919050565b600a54600090600160a060020a031633811461091d5760405160e860020a6282b42902815260040160405180910390fd5b6109477f00000000000000000000000000000000000000000000000000000000629e625342612eaf565b91505b5090565b600160a060020a03851633148061096a575061096a853361054e565b6109df5760405160e560020a62461bcd02815260206004820152603260248201527f455243313135353a207472616e736665722063616c6c6572206973206e6f742060448201527f6f776e6572206e6f7220617070726f7665640000000000000000000000000000606482015260840161064d565b6109ec8585858585611d11565b5050505050565b60225460ff1615610a495760405160e560020a62461bcd02815260206004820152600e60248201527f5265656e7472616e742043616c6c000000000000000000000000000000000000604482015260640161064d565b6022805460ff1916600117905533600081815260216020526040808220805490839055905190929083908381818185875af1925050503d8060008114610aab576040519150601f19603f3d011682016040523d82523d6000602084013e610ab0565b606091505b5050905080610ad45760405160e560020a62461bcd02815260040161064d90612ec6565b60408051338152602081018490527f5dba113b49cfa7c90315e8e604e6b506f7abcb909b01dcb19ec39005086e68fc910160405180910390a150506022805460ff1916905533600081815260216020526040808220805490839055905190929083908381818185875af1925050503d8060008114610b6e576040519150601f19603f3d011682016040523d82523d6000602084013e610b73565b606091505b5050905080610b975760405160e560020a62461bcd02815260040161064d90612ec6565b60408051338152602081018490527f5dba113b49cfa7c90315e8e604e6b506f7abcb909b01dcb19ec39005086e68fc91015b60405180910390a15050565b6000806000806000601554421115610bef57610bef611f0c565b60008060225462010000900460ff166001811115610c0f57610c0f612f23565b14610c46576040517fa264a95400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b601554421115610c82576040517fd02e774d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600a54600160a060020a03163314801590610ca85750600654600160a060020a03163314155b8015610cbf5750600554600160a060020a03163314155b610d345760405160e560020a62461bcd02815260206004820152603660248201527f4f776e65722c2062656e656669636961727920616e6420646576732063616e6e60448201527f6f7420626964206f6e20746869732061756374696f6e00000000000000000000606482015260840161064d565b6000878152601f6020526040902054610d6d7f00000000000000000000000000000000000000000000000000000000629e625342612eaf565b601454610d7a9190612f3c565b601354610d879190612eaf565b6000898152602360205260409020819055341015610dea5760405160e560020a62461bcd02815260206004820152601460248201527f426964206e6f74206869676820656e6f75676821000000000000000000000000604482015260640161064d565b610df5816001611f6c565b610e113389600160405180602001604052806000815250612039565b600088815260236020526040902054341115610e7757600088815260236020526040902054610e409034612eaf565b6000898152602360209081526040808320600201849055338352602190915281208054909190610e71908490612f5b565b90915550505b600088815260236020526040902060020154610e939034612eaf565b6000898152602360205260409020600101819055600454606491610eb79190612f3c565b610ec19190612f8c565b60008981526023602052604090206003810182905560010154610ee49190612eaf565b6000898152602360209081526040808320600481019485556003015460058054600160a060020a039081168652602190945282852091909155935460068054841685528285209190915533845281842054945483168452818420549054909216835290912054999a349a9299509097509095509350505050565b60608151835114610fda5760405160e560020a62461bcd02815260206004820152602960248201527f455243313135353a206163636f756e747320616e6420696473206c656e67746860448201527f206d69736d617463680000000000000000000000000000000000000000000000606482015260840161064d565b6000835167ffffffffffffffff811115610ff657610ff66127ee565b60405190808252806020026020018201604052801561101f578160200160208202803683370190505b50905060005b84518110156110975761106a85828151811061104357611043612fa0565b602002602001015185838151811061105d5761105d612fa0565b60200260200101516105d0565b82828151811061107c5761107c612fa0565b602090810291909101015261109081612fb9565b9050611025565b509392505050565b600a54600090600160a060020a03163381146110d05760405160e860020a6282b42902815260040160405180910390fd5b505060155490565b600a54600090600160a060020a03163381146111095760405160e860020a6282b42902815260040160405180910390fd5b6111116108ec565b60145461111e9190612f3c565b6013546109479190612eaf565b600a54600160a060020a03163381146111595760405160e860020a6282b42902815260040160405180910390fd5b60068054600160a060020a0385811673ffffffffffffffffffffffffffffffffffffffff199283168117909355600580549186169190921681179091556040805192835260208301919091527fc85d03f020ecd6e7e68d949922d7bfbf9b0ac67d6e9d24792773b8df88a89dea91016107d2565b6111d833838361216c565b5050565b600a546000908190600160a060020a031633811461120f5760405160e860020a6282b42902815260040160405180910390fd5b5050600654600554600160a060020a039182169391169150565b600b805461123690612d2f565b80601f016020809104026020016040519081016040528092919081815260200182805461126290612d2f565b80156112af5780601f10611284576101008083540402835291602001916112af565b820191906000526020600020905b81548152906001019060200180831161129257829003601f168201915b505050505081565b6007544211156112c9576112c9612263565b600080602254610100900460ff1660018111156112e8576112e8612f23565b1461131f576040517fa264a95400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b33611356576040517fe6c4247b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6010548211158015611373575060105461137033856105d0565b11155b6113925760405160e560020a62461bcd02815260040161064d90612fd2565b600a54600160a060020a031633036113d6576040517fc60e5a8800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600654600160a060020a0316330361141a576040517f7b227b2c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600554600160a060020a0316330361145e576040517f3ef2e87c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6000601f60008581526020019081526020016000205490506000806000806016858154811061148f5761148f612fa0565b9060005260206000209060030201600101549350601685815481106114b6576114b6612fa0565b9060005260206000209060030201600201549050868110156115425760405160e560020a62461bcd028152602060048201526024808201527f455243313135353a20536f7272792c2074686973204e4654277320736f6c642060448201527f6f75742100000000000000000000000000000000000000000000000000000000606482015260840161064d565b61154c8785612f3c565b341015611585576040517f500a07ce00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b61158f8588611f6c565b6115aa33898960405180602001604052806000815250612039565b6064600454346115ba9190612f3c565b6115c49190612f8c565b92506115d08334612eaf565b600554600160a060020a03908116600090815260216020526040808220969096556006549091168152939093209290925550505050505050565b61162e60405180606001604052806000815260200160008152602001600081525090565b60008281526020805260409020805461164690612d2f565b905060000361169a5760405160e560020a62461bcd02815260206004820152601960248201527f5468697320746f6b656e20646f65736e27742065786973742100000000000000604482015260640161064d565b6000828152601f602052604090205460168054829081106116bd576116bd612fa0565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050915050919050565b60008060075442111561171157611711612263565b600080602254610100900460ff16600181111561173057611730612f23565b14611767576040517fa264a95400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b3361179e576040517fe6c4247b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600a54600160a060020a031633036117e2576040517fc60e5a8800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600654600160a060020a03163303611826576040517f7b227b2c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600554600160a060020a0316330361186a576040517f3ef2e87c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6000601c8190555b8551811015611a6757601f600087838151811061189157611891612fa0565b60200260200101518152602001908152602001600020546017600001819055508581815181106118c3576118c3612fa0565b60200260200101516017600101819055506016601760000154815481106118ec576118ec612fa0565b600091825260209091206001600390920201015460195560175460168054909190811061191b5761191b612fa0565b90600052602060002090600302016002015460176003018190555084818151811061194857611948612fa0565b6020908102919091010151601b819055601a5410156119d25760405160e560020a62461bcd02815260206004820152603260248201527f455243313135353a204e6f7420656e6f756768204e465473206f66207468697360448201527f20746f6b656e496420696e2073746f636b210000000000000000000000000000606482015260840161064d565b601054601b54118015906119f657506010546119f3336017600101546105d0565b11155b611a155760405160e560020a62461bcd02815260040161064d90612fd2565b601754601b54611a259190611f6c565b601854601b54611a3591906112b7565b601b54601954611a459190612f3c565b601c54611a529190612f5b565b601c5580611a5f81612fb9565b915050611872565b50601c54341015611aa4576040517f500a07ce00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600454601c54606491611ab691612f3c565b611ac09190612f8c565b601e819055601c54611ad29190612eaf565b601d908155601e54600554600160a060020a0390811660009081526021602052604080822093909355925460065490911683529120555050601c543494909350915050565b600160a060020a038516331480611b335750611b33853361054e565b611ba85760405160e560020a62461bcd02815260206004820152602960248201527f455243313135353a2063616c6c6572206973206e6f74206f776e6572206e6f7260448201527f20617070726f7665640000000000000000000000000000000000000000000000606482015260840161064d565b6109ec85858585856122b9565b606081600003611bf857505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b8115611c225780611c0c81612fb9565b9150611c1b9050600a83612f8c565b9150611bfc565b60008167ffffffffffffffff811115611c3d57611c3d6127ee565b6040519080825280601f01601f191660200182016040528015611c67576020820181803683370190505b5090505b8415611d0957611c7c600183612eaf565b9150611c89600a8661302f565b611c94906030612f5b565b7f010000000000000000000000000000000000000000000000000000000000000002818381518110611cc857611cc8612fa0565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350611d02600a86612f8c565b9450611c6b565b949350505050565b8151835114611d8b5760405160e560020a62461bcd02815260206004820152602860248201527f455243313135353a2069647320616e6420616d6f756e7473206c656e6774682060448201527f6d69736d61746368000000000000000000000000000000000000000000000000606482015260840161064d565b600160a060020a038416611db45760405160e560020a62461bcd02815260040161064d90613043565b3360005b8451811015611e9e576000858281518110611dd557611dd5612fa0565b602002602001015190506000858381518110611df357611df3612fa0565b60209081029190910181015160008481528083526040808220600160a060020a038e168352909352919091205490915081811015611e465760405160e560020a62461bcd02815260040161064d906130a0565b600083815260208181526040808320600160a060020a038e8116855292528083208585039055908b16825281208054849290611e83908490612f5b565b9250508190555050505080611e9790612fb9565b9050611db8565b5084600160a060020a031686600160a060020a031682600160a060020a03167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8787604051611eee9291906130fd565b60405180910390a4611f048187878787876123e9565b505050505050565b60225462010000900460ff166001811115611f2957611f29612f23565b611f34906001612f5b565b6001811115611f4557611f45612f23565b6022805462ff0000191662010000836001811115611f6557611f65612f23565b0217905550565b8060168381548110611f8057611f80612fa0565b9060005260206000209060030201600201541015611fca576040517fdec32ed000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8060168381548110611fde57611fde612fa0565b90600052602060002090600302016002016000828254611ffe9190612eaf565b909155505060408051838152602081018390527f7517bbe60f7c67f45055242fdee9b505e18c8822d32012fe33c18e5439cee1f29101610bc9565b600160a060020a0384166120b85760405160e560020a62461bcd02815260206004820152602160248201527f455243313135353a206d696e7420746f20746865207a65726f2061646472657360448201527f7300000000000000000000000000000000000000000000000000000000000000606482015260840161064d565b3360006120c485612588565b905060006120d185612588565b9050600086815260208181526040808320600160a060020a038b16845290915281208054879290612103908490612f5b565b90915550506040805187815260208101879052600160a060020a03808a1692600092918716917fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62910160405180910390a4612163836000898989896125d3565b50505050505050565b81600160a060020a031683600160a060020a0316036121f65760405160e560020a62461bcd02815260206004820152602960248201527f455243313135353a2073657474696e6720617070726f76616c2073746174757360448201527f20666f722073656c660000000000000000000000000000000000000000000000606482015260840161064d565b600160a060020a03838116600081815260016020908152604080832094871680845294825291829020805460ff191686151590811790915591519182527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a3505050565b602254610100900460ff16600181111561227f5761227f612f23565b61228a906001612f5b565b600181111561229b5761229b612f23565b6022805461ff001916610100836001811115611f6557611f65612f23565b600160a060020a0384166122e25760405160e560020a62461bcd02815260040161064d90613043565b3360006122ee85612588565b905060006122fb85612588565b9050600086815260208181526040808320600160a060020a038c168452909152902054858110156123415760405160e560020a62461bcd02815260040161064d906130a0565b600087815260208181526040808320600160a060020a038d8116855292528083208985039055908a1682528120805488929061237e908490612f5b565b90915550506040805188815260208101889052600160a060020a03808b16928c821692918816917fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62910160405180910390a46123de848a8a8a8a8a6125d3565b505050505050505050565b600160a060020a0384163b15611f04576040517fbc197c81000000000000000000000000000000000000000000000000000000008152600160a060020a0385169063bc197c8190612446908990899088908890889060040161312b565b6020604051808303816000875af1925050508015612481575060408051601f3d908101601f1916820190925261247e91810190613189565b60015b61253c5761248d6131a6565b806308c379a0036124c957506124a16131df565b806124ac57506124cb565b8060405160e560020a62461bcd02815260040161064d9190612960565b505b60405160e560020a62461bcd02815260206004820152603460248201527f455243313135353a207472616e7366657220746f206e6f6e204552433131353560448201527f526563656976657220696d706c656d656e746572000000000000000000000000606482015260840161064d565b600160e060020a031981167fbc197c8100000000000000000000000000000000000000000000000000000000146121635760405160e560020a62461bcd02815260040161064d90613269565b604080516001808252818301909252606091600091906020808301908036833701905050905082816000815181106125c2576125c2612fa0565b602090810291909101015292915050565b600160a060020a0384163b15611f04576040517ff23a6e61000000000000000000000000000000000000000000000000000000008152600160a060020a0385169063f23a6e619061263090899089908890889088906004016132c6565b6020604051808303816000875af192505050801561266b575060408051601f3d908101601f1916820190925261266891810190613189565b60015b6126775761248d6131a6565b600160e060020a031981167ff23a6e6100000000000000000000000000000000000000000000000000000000146121635760405160e560020a62461bcd02815260040161064d90613269565b8280546126cf90612d2f565b90600052602060002090601f0160209004810192826126f15760008555612737565b82601f1061270a57805160ff1916838001178555612737565b82800160010185558215612737579182015b8281111561273757825182559160200191906001019061271c565b5061094a9291505b8082111561094a576000815560010161273f565b600160a060020a038116811461276857600080fd5b50565b6000806040838503121561277e57600080fd5b823561278981612753565b946020939093013593505050565b600160e060020a03198116811461276857600080fd5b6000602082840312156127bf57600080fd5b81356127ca81612797565b9392505050565b6000602082840312156127e357600080fd5b81356127ca81612753565b60e060020a634e487b7102600052604160045260246000fd5b601f8201601f1916810167ffffffffffffffff8111828210171561282d5761282d6127ee565b6040525050565b600067ffffffffffffffff83111561284e5761284e6127ee565b604051612865601f8501601f191660200182612807565b80915083815284848401111561287a57600080fd5b83836020830137600060208583010152509392505050565b600080604083850312156128a557600080fd5b823567ffffffffffffffff8111156128bc57600080fd5b8301601f810185136128cd57600080fd5b6128dc85823560208401612834565b95602094909401359450505050565b6000602082840312156128fd57600080fd5b5035919050565b60005b8381101561291f578181015183820152602001612907565b8381111561292e576000848401525b50505050565b6000815180845261294c816020860160208601612904565b601f01601f19169290920160200192915050565b6020815260006127ca6020830184612934565b600067ffffffffffffffff82111561298d5761298d6127ee565b5060209081020190565b600082601f8301126129a857600080fd5b813560206129b582612973565b6040516129c28282612807565b83815292820285018201928281019150868411156129df57600080fd5b8286015b848110156129fa57803583529183019183016129e3565b509695505050505050565b600082601f830112612a1657600080fd5b6127ca83833560208501612834565b600080600080600060a08688031215612a3d57600080fd5b8535612a4881612753565b94506020860135612a5881612753565b9350604086013567ffffffffffffffff80821115612a7557600080fd5b612a8189838a01612997565b94506060880135915080821115612a9757600080fd5b612aa389838a01612997565b93506080880135915080821115612ab957600080fd5b50612ac688828901612a05565b9150509295509295909350565b60008060408385031215612ae657600080fd5b823567ffffffffffffffff80821115612afe57600080fd5b818501915085601f830112612b1257600080fd5b81356020612b1f82612973565b604051612b2c8282612807565b8381529282028501820192828101915089841115612b4957600080fd5b948201945b83861015612b70578535612b6181612753565b82529482019490820190612b4e565b96505086013592505080821115612b8657600080fd5b50612b9385828601612997565b9150509250929050565b600081518084526020808501945080840160005b83811015612bcd57815187529582019590820190600101612bb1565b509495945050505050565b6020815260006127ca6020830184612b9d565b60008060408385031215612bfe57600080fd5b8235612c0981612753565b91506020830135612c1981612753565b809150509250929050565b60008060408385031215612c3757600080fd5b8235612c4281612753565b915060208301358015158114612c1957600080fd5b60008060408385031215612c6a57600080fd5b50508035926020909101359150565b60008060408385031215612c8c57600080fd5b823567ffffffffffffffff80821115612ca457600080fd5b612cb086838701612997565b93506020850135915080821115612b8657600080fd5b600080600080600060a08688031215612cde57600080fd5b8535612ce981612753565b94506020860135612cf981612753565b93506040860135925060608601359150608086013567ffffffffffffffff811115612d2357600080fd5b612ac688828901612a05565b600281046001821680612d4357607f821691505b602082108103612d665760e060020a634e487b7102600052602260045260246000fd5b50919050565b600084516020612d7f8285838a01612904565b855191840191612d928184848a01612904565b8554920191600090612da381612d2f565b60018281168015612dbb5760018114612dcc57612df8565b60ff19841687528287019450612df8565b896000528560002060005b84811015612df057815489820152908301908701612dd7565b505082870194505b50929a9950505050505050505050565b604081526000808454612e1a81612d2f565b8060408601526060600180841660008114612e3c5760018114612e5057612e81565b60ff19851688840152608088019550612e81565b8960005260208060002060005b86811015612e785781548b8201870152908401908201612e5d565b8a018501975050505b50505050506020929092019290925292915050565b60e060020a634e487b7102600052601160045260246000fd5b600082821015612ec157612ec1612e96565b500390565b60208082526021908201527f4f776e6572207061796d656e74207472616e73616374696f6e206661696c656460408201527f2100000000000000000000000000000000000000000000000000000000000000606082015260800190565b60e060020a634e487b7102600052602160045260246000fd5b6000816000190483118215151615612f5657612f56612e96565b500290565b60008219821115612f6e57612f6e612e96565b500190565b60e060020a634e487b7102600052601260045260246000fd5b600082612f9b57612f9b612f73565b500490565b60e060020a634e487b7102600052603260045260246000fd5b600060018201612fcb57612fcb612e96565b5060010190565b60208082526026908201527f546865726527732061206c696d697420746f206d696e74696e6720706572206160408201527f6464726573730000000000000000000000000000000000000000000000000000606082015260800190565b60008261303e5761303e612f73565b500690565b60208082526025908201527f455243313135353a207472616e7366657220746f20746865207a65726f20616460408201527f6472657373000000000000000000000000000000000000000000000000000000606082015260800190565b6020808252602a908201527f455243313135353a20696e73756666696369656e742062616c616e636520666f60408201527f72207472616e7366657200000000000000000000000000000000000000000000606082015260800190565b6040815260006131106040830185612b9d565b82810360208401526131228185612b9d565b95945050505050565b6000600160a060020a03808816835280871660208401525060a0604083015261315760a0830186612b9d565b82810360608401526131698186612b9d565b9050828103608084015261317d8185612934565b98975050505050505050565b60006020828403121561319b57600080fd5b81516127ca81612797565b600060033d11156131dc5760046000803e7c01000000000000000000000000000000000000000000000000000000006000510490505b90565b600060443d10156131ed5790565b6040516003193d81016004833e81513d67ffffffffffffffff816024840111818411171561321d57505050505090565b82850191508151818111156132355750505050505090565b843d870101602082850101111561324f5750505050505090565b61325e60208286010187612807565b509095945050505050565b60208082526028908201527f455243313135353a204552433131353552656365697665722072656a6563746560408201527f6420746f6b656e73000000000000000000000000000000000000000000000000606082015260800190565b6000600160a060020a03808816835280871660208401525084604083015283606083015260a060808301526132fe60a0830184612934565b97965050505050505056fea26469706673582212206995e742869723992f35e7fcddb43928023608afb3a1243e1c583a877fb571ed64736f6c634300080e0033

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts (last updated v4.6.0) (utils/math/SafeMath.sol)

pragma solidity ^0.8.0;

// CAUTION
// This version of SafeMath should only be used with Solidity 0.8 or later,
// because it relies on the compiler's built in overflow checks.

/**
 * @dev Wrappers over Solidity's arithmetic operations.
 *
 * NOTE: `SafeMath` is generally not needed starting with Solidity 0.8, since the compiler
 * now has built in overflow checking.
 */
library SafeMath {
    /**
     * @dev Returns the addition of two unsigned integers, with an overflow flag.
     *
     * _Available since v3.4._
     */
    function tryAdd(uint256 a, uint256 b) internal pure returns (bool, uint256) {
        unchecked {
            uint256 c = a + b;
            if (c < a) return (false, 0);
            return (true, c);
        }
    }

    /**
     * @dev Returns the subtraction of two unsigned integers, with an overflow flag.
     *
     * _Available since v3.4._
     */
    function trySub(uint256 a, uint256 b) internal pure returns (bool, uint256) {
        unchecked {
            if (b > a) return (false, 0);
            return (true, a - b);
        }
    }

    /**
     * @dev Returns the multiplication of two unsigned integers, with an overflow flag.
     *
     * _Available since v3.4._
     */
    function tryMul(uint256 a, uint256 b) internal pure returns (bool, uint256) {
        unchecked {
            // Gas optimization: this is cheaper than requiring 'a' not being zero, but the
            // benefit is lost if 'b' is also tested.
            // See: https://github.com/OpenZeppelin/openzeppelin-contracts/pull/522
            if (a == 0) return (true, 0);
            uint256 c = a * b;
            if (c / a != b) return (false, 0);
            return (true, c);
        }
    }

    /**
     * @dev Returns the division of two unsigned integers, with a division by zero flag.
     *
     * _Available since v3.4._
     */
    function tryDiv(uint256 a, uint256 b) internal pure returns (bool, uint256) {
        unchecked {
            if (b == 0) return (false, 0);
            return (true, a / b);
        }
    }

    /**
     * @dev Returns the remainder of dividing two unsigned integers, with a division by zero flag.
     *
     * _Available since v3.4._
     */
    function tryMod(uint256 a, uint256 b) internal pure returns (bool, uint256) {
        unchecked {
            if (b == 0) return (false, 0);
            return (true, a % b);
        }
    }

    /**
     * @dev Returns the addition of two unsigned integers, reverting on
     * overflow.
     *
     * Counterpart to Solidity's `+` operator.
     *
     * Requirements:
     *
     * - Addition cannot overflow.
     */
    function add(uint256 a, uint256 b) internal pure returns (uint256) {
        return a + b;
    }

    /**
     * @dev Returns the subtraction of two unsigned integers, reverting on
     * overflow (when the result is negative).
     *
     * Counterpart to Solidity's `-` operator.
     *
     * Requirements:
     *
     * - Subtraction cannot overflow.
     */
    function sub(uint256 a, uint256 b) internal pure returns (uint256) {
        return a - b;
    }

    /**
     * @dev Returns the multiplication of two unsigned integers, reverting on
     * overflow.
     *
     * Counterpart to Solidity's `*` operator.
     *
     * Requirements:
     *
     * - Multiplication cannot overflow.
     */
    function mul(uint256 a, uint256 b) internal pure returns (uint256) {
        return a * b;
    }

    /**
     * @dev Returns the integer division of two unsigned integers, reverting on
     * division by zero. The result is rounded towards zero.
     *
     * Counterpart to Solidity's `/` operator.
     *
     * Requirements:
     *
     * - The divisor cannot be zero.
     */
    function div(uint256 a, uint256 b) internal pure returns (uint256) {
        return a / b;
    }

    /**
     * @dev Returns the remainder of dividing two unsigned integers. (unsigned integer modulo),
     * reverting when dividing by zero.
     *
     * Counterpart to Solidity's `%` operator. This function uses a `revert`
     * opcode (which leaves remaining gas untouched) while Solidity uses an
     * invalid opcode to revert (consuming all remaining gas).
     *
     * Requirements:
     *
     * - The divisor cannot be zero.
     */
    function mod(uint256 a, uint256 b) internal pure returns (uint256) {
        return a % b;
    }

    /**
     * @dev Returns the subtraction of two unsigned integers, reverting with custom message on
     * overflow (when the result is negative).
     *
     * CAUTION: This function is deprecated because it requires allocating memory for the error
     * message unnecessarily. For custom revert reasons use {trySub}.
     *
     * Counterpart to Solidity's `-` operator.
     *
     * Requirements:
     *
     * - Subtraction cannot overflow.
     */
    function sub(
        uint256 a,
        uint256 b,
        string memory errorMessage
    ) internal pure returns (uint256) {
        unchecked {
            require(b <= a, errorMessage);
            return a - b;
        }
    }

    /**
     * @dev Returns the integer division of two unsigned integers, reverting with custom message on
     * division by zero. The result is rounded towards zero.
     *
     * Counterpart to Solidity's `/` operator. Note: this function uses a
     * `revert` opcode (which leaves remaining gas untouched) while Solidity
     * uses an invalid opcode to revert (consuming all remaining gas).
     *
     * Requirements:
     *
     * - The divisor cannot be zero.
     */
    function div(
        uint256 a,
        uint256 b,
        string memory errorMessage
    ) internal pure returns (uint256) {
        unchecked {
            require(b > 0, errorMessage);
            return a / b;
        }
    }

    /**
     * @dev Returns the remainder of dividing two unsigned integers. (unsigned integer modulo),
     * reverting with custom message when dividing by zero.
     *
     * CAUTION: This function is deprecated because it requires allocating memory for the error
     * message unnecessarily. For custom revert reasons use {tryMod}.
     *
     * Counterpart to Solidity's `%` operator. This function uses a `revert`
     * opcode (which leaves remaining gas untouched) while Solidity uses an
     * invalid opcode to revert (consuming all remaining gas).
     *
     * Requirements:
     *
     * - The divisor cannot be zero.
     */
    function mod(
        uint256 a,
        uint256 b,
        string memory errorMessage
    ) internal pure returns (uint256) {
        unchecked {
            require(b > 0, errorMessage);
            return a % b;
        }
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (utils/introspection/IERC165.sol)

pragma solidity ^0.8.0;

/**
 * @dev Interface of the ERC165 standard, as defined in the
 * https://eips.ethereum.org/EIPS/eip-165[EIP].
 *
 * Implementers can declare support of contract interfaces, which can then be
 * queried by others ({ERC165Checker}).
 *
 * For an implementation, see {ERC165}.
 */
interface IERC165 {
    /**
     * @dev Returns true if this contract implements the interface defined by
     * `interfaceId`. See the corresponding
     * https://eips.ethereum.org/EIPS/eip-165#how-interfaces-are-identified[EIP section]
     * to learn more about how these ids are created.
     *
     * This function call must use less than 30 000 gas.
     */
    function supportsInterface(bytes4 interfaceId) external view returns (bool);
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (utils/introspection/ERC165.sol)

pragma solidity ^0.8.0;

import "./IERC165.sol";

/**
 * @dev Implementation of the {IERC165} interface.
 *
 * Contracts that want to implement ERC165 should inherit from this contract and override {supportsInterface} to check
 * for the additional interface id that will be supported. For example:
 *
 * ```solidity
 * function supportsInterface(bytes4 interfaceId) public view virtual override returns (bool) {
 *     return interfaceId == type(MyInterface).interfaceId || super.supportsInterface(interfaceId);
 * }
 * ```
 *
 * Alternatively, {ERC165Storage} provides an easier to use but more expensive implementation.
 */
abstract contract ERC165 is IERC165 {
    /**
     * @dev See {IERC165-supportsInterface}.
     */
    function supportsInterface(bytes4 interfaceId) public view virtual override returns (bool) {
        return interfaceId == type(IERC165).interfaceId;
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (utils/Strings.sol)

pragma solidity ^0.8.0;

/**
 * @dev String operations.
 */
library Strings {
    bytes16 private constant _HEX_SYMBOLS = "0123456789abcdef";

    /**
     * @dev Converts a `uint256` to its ASCII `string` decimal representation.
     */
    function toString(uint256 value) internal pure returns (string memory) {
        // Inspired by OraclizeAPI's implementation - MIT licence
        // https://github.com/oraclize/ethereum-api/blob/b42146b063c7d6ee1358846c198246239e9360e8/oraclizeAPI_0.4.25.sol

        if (value == 0) {
            return "0";
        }
        uint256 temp = value;
        uint256 digits;
        while (temp != 0) {
            digits++;
            temp /= 10;
        }
        bytes memory buffer = new bytes(digits);
        while (value != 0) {
            digits -= 1;
            buffer[digits] = bytes1(uint8(48 + uint256(value % 10)));
            value /= 10;
        }
        return string(buffer);
    }

    /**
     * @dev Converts a `uint256` to its ASCII `string` hexadecimal representation.
     */
    function toHexString(uint256 value) internal pure returns (string memory) {
        if (value == 0) {
            return "0x00";
        }
        uint256 temp = value;
        uint256 length = 0;
        while (temp != 0) {
            length++;
            temp >>= 8;
        }
        return toHexString(value, length);
    }

    /**
     * @dev Converts a `uint256` to its ASCII `string` hexadecimal representation with fixed length.
     */
    function toHexString(uint256 value, uint256 length) internal pure returns (string memory) {
        bytes memory buffer = new bytes(2 * length + 2);
        buffer[0] = "0";
        buffer[1] = "x";
        for (uint256 i = 2 * length + 1; i > 1; --i) {
            buffer[i] = _HEX_SYMBOLS[value & 0xf];
            value >>= 4;
        }
        require(value == 0, "Strings: hex length insufficient");
        return string(buffer);
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (utils/Context.sol)

pragma solidity ^0.8.0;

/**
 * @dev Provides information about the current execution context, including the
 * sender of the transaction and its data. While these are generally available
 * via msg.sender and msg.data, they should not be accessed in such a direct
 * manner, since when dealing with meta-transactions the account sending and
 * paying for execution may not be the actual sender (as far as an application
 * is concerned).
 *
 * This contract is only required for intermediate, library-like contracts.
 */
abstract contract Context {
    function _msgSender() internal view virtual returns (address) {
        return msg.sender;
    }

    function _msgData() internal view virtual returns (bytes calldata) {
        return msg.data;
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts (last updated v4.5.0) (utils/Address.sol)

pragma solidity ^0.8.1;

/**
 * @dev Collection of functions related to the address type
 */
library Address {
    /**
     * @dev Returns true if `account` is a contract.
     *
     * [IMPORTANT]
     * ====
     * It is unsafe to assume that an address for which this function returns
     * false is an externally-owned account (EOA) and not a contract.
     *
     * Among others, `isContract` will return false for the following
     * types of addresses:
     *
     *  - an externally-owned account
     *  - a contract in construction
     *  - an address where a contract will be created
     *  - an address where a contract lived, but was destroyed
     * ====
     *
     * [IMPORTANT]
     * ====
     * You shouldn't rely on `isContract` to protect against flash loan attacks!
     *
     * Preventing calls from contracts is highly discouraged. It breaks composability, breaks support for smart wallets
     * like Gnosis Safe, and does not provide security since it can be circumvented by calling from a contract
     * constructor.
     * ====
     */
    function isContract(address account) internal view returns (bool) {
        // This method relies on extcodesize/address.code.length, which returns 0
        // for contracts in construction, since the code is only stored at the end
        // of the constructor execution.

        return account.code.length > 0;
    }

    /**
     * @dev Replacement for Solidity's `transfer`: sends `amount` wei to
     * `recipient`, forwarding all available gas and reverting on errors.
     *
     * https://eips.ethereum.org/EIPS/eip-1884[EIP1884] increases the gas cost
     * of certain opcodes, possibly making contracts go over the 2300 gas limit
     * imposed by `transfer`, making them unable to receive funds via
     * `transfer`. {sendValue} removes this limitation.
     *
     * https://diligence.consensys.net/posts/2019/09/stop-using-soliditys-transfer-now/[Learn more].
     *
     * IMPORTANT: because control is transferred to `recipient`, care must be
     * taken to not create reentrancy vulnerabilities. Consider using
     * {ReentrancyGuard} or the
     * https://solidity.readthedocs.io/en/v0.5.11/security-considerations.html#use-the-checks-effects-interactions-pattern[checks-effects-interactions pattern].
     */
    function sendValue(address payable recipient, uint256 amount) internal {
        require(address(this).balance >= amount, "Address: insufficient balance");

        (bool success, ) = recipient.call{value: amount}("");
        require(success, "Address: unable to send value, recipient may have reverted");
    }

    /**
     * @dev Performs a Solidity function call using a low level `call`. A
     * plain `call` is an unsafe replacement for a function call: use this
     * function instead.
     *
     * If `target` reverts with a revert reason, it is bubbled up by this
     * function (like regular Solidity function calls).
     *
     * Returns the raw returned data. To convert to the expected return value,
     * use https://solidity.readthedocs.io/en/latest/units-and-global-variables.html?highlight=abi.decode#abi-encoding-and-decoding-functions[`abi.decode`].
     *
     * Requirements:
     *
     * - `target` must be a contract.
     * - calling `target` with `data` must not revert.
     *
     * _Available since v3.1._
     */
    function functionCall(address target, bytes memory data) internal returns (bytes memory) {
        return functionCall(target, data, "Address: low-level call failed");
    }

    /**
     * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`], but with
     * `errorMessage` as a fallback revert reason when `target` reverts.
     *
     * _Available since v3.1._
     */
    function functionCall(
        address target,
        bytes memory data,
        string memory errorMessage
    ) internal returns (bytes memory) {
        return functionCallWithValue(target, data, 0, errorMessage);
    }

    /**
     * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`],
     * but also transferring `value` wei to `target`.
     *
     * Requirements:
     *
     * - the calling contract must have an ETH balance of at least `value`.
     * - the called Solidity function must be `payable`.
     *
     * _Available since v3.1._
     */
    function functionCallWithValue(
        address target,
        bytes memory data,
        uint256 value
    ) internal returns (bytes memory) {
        return functionCallWithValue(target, data, value, "Address: low-level call with value failed");
    }

    /**
     * @dev Same as {xref-Address-functionCallWithValue-address-bytes-uint256-}[`functionCallWithValue`], but
     * with `errorMessage` as a fallback revert reason when `target` reverts.
     *
     * _Available since v3.1._
     */
    function functionCallWithValue(
        address target,
        bytes memory data,
        uint256 value,
        string memory errorMessage
    ) internal returns (bytes memory) {
        require(address(this).balance >= value, "Address: insufficient balance for call");
        require(isContract(target), "Address: call to non-contract");

        (bool success, bytes memory returndata) = target.call{value: value}(data);
        return verifyCallResult(success, returndata, errorMessage);
    }

    /**
     * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`],
     * but performing a static call.
     *
     * _Available since v3.3._
     */
    function functionStaticCall(address target, bytes memory data) internal view returns (bytes memory) {
        return functionStaticCall(target, data, "Address: low-level static call failed");
    }

    /**
     * @dev Same as {xref-Address-functionCall-address-bytes-string-}[`functionCall`],
     * but performing a static call.
     *
     * _Available since v3.3._
     */
    function functionStaticCall(
        address target,
        bytes memory data,
        string memory errorMessage
    ) internal view returns (bytes memory) {
        require(isContract(target), "Address: static call to non-contract");

        (bool success, bytes memory returndata) = target.staticcall(data);
        return verifyCallResult(success, returndata, errorMessage);
    }

    /**
     * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`],
     * but performing a delegate call.
     *
     * _Available since v3.4._
     */
    function functionDelegateCall(address target, bytes memory data) internal returns (bytes memory) {
        return functionDelegateCall(target, data, "Address: low-level delegate call failed");
    }

    /**
     * @dev Same as {xref-Address-functionCall-address-bytes-string-}[`functionCall`],
     * but performing a delegate call.
     *
     * _Available since v3.4._
     */
    function functionDelegateCall(
        address target,
        bytes memory data,
        string memory errorMessage
    ) internal returns (bytes memory) {
        require(isContract(target), "Address: delegate call to non-contract");

        (bool success, bytes memory returndata) = target.delegatecall(data);
        return verifyCallResult(success, returndata, errorMessage);
    }

    /**
     * @dev Tool to verifies that a low level call was successful, and revert if it wasn't, either by bubbling the
     * revert reason using the provided one.
     *
     * _Available since v4.3._
     */
    function verifyCallResult(
        bool success,
        bytes memory returndata,
        string memory errorMessage
    ) internal pure returns (bytes memory) {
        if (success) {
            return returndata;
        } else {
            // Look for revert reason and bubble it up if present
            if (returndata.length > 0) {
                // The easiest way to bubble the revert reason is using memory via assembly

                assembly {
                    let returndata_size := mload(returndata)
                    revert(add(32, returndata), returndata_size)
                }
            } else {
                revert(errorMessage);
            }
        }
    }
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (token/ERC1155/extensions/IERC1155MetadataURI.sol)

pragma solidity ^0.8.0;

import "../IERC1155.sol";

/**
 * @dev Interface of the optional ERC1155MetadataExtension interface, as defined
 * in the https://eips.ethereum.org/EIPS/eip-1155#metadata-extensions[EIP].
 *
 * _Available since v3.1._
 */
interface IERC1155MetadataURI is IERC1155 {
    /**
     * @dev Returns the URI for token type `id`.
     *
     * If the `\{id\}` substring is present in the URI, it must be replaced by
     * clients with the actual token type ID.
     */
    function uri(uint256 id) external view returns (string memory);
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts (last updated v4.5.0) (token/ERC1155/IERC1155Receiver.sol)

pragma solidity ^0.8.0;

import "../../utils/introspection/IERC165.sol";

/**
 * @dev _Available since v3.1._
 */
interface IERC1155Receiver is IERC165 {
    /**
     * @dev Handles the receipt of a single ERC1155 token type. This function is
     * called at the end of a `safeTransferFrom` after the balance has been updated.
     *
     * NOTE: To accept the transfer, this must return
     * `bytes4(keccak256("onERC1155Received(address,address,uint256,uint256,bytes)"))`
     * (i.e. 0xf23a6e61, or its own function selector).
     *
     * @param operator The address which initiated the transfer (i.e. msg.sender)
     * @param from The address which previously owned the token
     * @param id The ID of the token being transferred
     * @param value The amount of tokens being transferred
     * @param data Additional data with no specified format
     * @return `bytes4(keccak256("onERC1155Received(address,address,uint256,uint256,bytes)"))` if transfer is allowed
     */
    function onERC1155Received(
        address operator,
        address from,
        uint256 id,
        uint256 value,
        bytes calldata data
    ) external returns (bytes4);

    /**
     * @dev Handles the receipt of a multiple ERC1155 token types. This function
     * is called at the end of a `safeBatchTransferFrom` after the balances have
     * been updated.
     *
     * NOTE: To accept the transfer(s), this must return
     * `bytes4(keccak256("onERC1155BatchReceived(address,address,uint256[],uint256[],bytes)"))`
     * (i.e. 0xbc197c81, or its own function selector).
     *
     * @param operator The address which initiated the batch transfer (i.e. msg.sender)
     * @param from The address which previously owned the token
     * @param ids An array containing ids of each token being transferred (order and length must match values array)
     * @param values An array containing amounts of each token being transferred (order and length must match ids array)
     * @param data Additional data with no specified format
     * @return `bytes4(keccak256("onERC1155BatchReceived(address,address,uint256[],uint256[],bytes)"))` if transfer is allowed
     */
    function onERC1155BatchReceived(
        address operator,
        address from,
        uint256[] calldata ids,
        uint256[] calldata values,
        bytes calldata data
    ) external returns (bytes4);
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts v4.4.1 (token/ERC1155/IERC1155.sol)

pragma solidity ^0.8.0;

import "../../utils/introspection/IERC165.sol";

/**
 * @dev Required interface of an ERC1155 compliant contract, as defined in the
 * https://eips.ethereum.org/EIPS/eip-1155[EIP].
 *
 * _Available since v3.1._
 */
interface IERC1155 is IERC165 {
    /**
     * @dev Emitted when `value` tokens of token type `id` are transferred from `from` to `to` by `operator`.
     */
    event TransferSingle(address indexed operator, address indexed from, address indexed to, uint256 id, uint256 value);

    /**
     * @dev Equivalent to multiple {TransferSingle} events, where `operator`, `from` and `to` are the same for all
     * transfers.
     */
    event TransferBatch(
        address indexed operator,
        address indexed from,
        address indexed to,
        uint256[] ids,
        uint256[] values
    );

    /**
     * @dev Emitted when `account` grants or revokes permission to `operator` to transfer their tokens, according to
     * `approved`.
     */
    event ApprovalForAll(address indexed account, address indexed operator, bool approved);

    /**
     * @dev Emitted when the URI for token type `id` changes to `value`, if it is a non-programmatic URI.
     *
     * If an {URI} event was emitted for `id`, the standard
     * https://eips.ethereum.org/EIPS/eip-1155#metadata-extensions[guarantees] that `value` will equal the value
     * returned by {IERC1155MetadataURI-uri}.
     */
    event URI(string value, uint256 indexed id);

    /**
     * @dev Returns the amount of tokens of token type `id` owned by `account`.
     *
     * Requirements:
     *
     * - `account` cannot be the zero address.
     */
    function balanceOf(address account, uint256 id) external view returns (uint256);

    /**
     * @dev xref:ROOT:erc1155.adoc#batch-operations[Batched] version of {balanceOf}.
     *
     * Requirements:
     *
     * - `accounts` and `ids` must have the same length.
     */
    function balanceOfBatch(address[] calldata accounts, uint256[] calldata ids)
        external
        view
        returns (uint256[] memory);

    /**
     * @dev Grants or revokes permission to `operator` to transfer the caller's tokens, according to `approved`,
     *
     * Emits an {ApprovalForAll} event.
     *
     * Requirements:
     *
     * - `operator` cannot be the caller.
     */
    function setApprovalForAll(address operator, bool approved) external;

    /**
     * @dev Returns true if `operator` is approved to transfer ``account``'s tokens.
     *
     * See {setApprovalForAll}.
     */
    function isApprovedForAll(address account, address operator) external view returns (bool);

    /**
     * @dev Transfers `amount` tokens of token type `id` from `from` to `to`.
     *
     * Emits a {TransferSingle} event.
     *
     * Requirements:
     *
     * - `to` cannot be the zero address.
     * - If the caller is not `from`, it must be have been approved to spend ``from``'s tokens via {setApprovalForAll}.
     * - `from` must have a balance of tokens of type `id` of at least `amount`.
     * - If `to` refers to a smart contract, it must implement {IERC1155Receiver-onERC1155Received} and return the
     * acceptance magic value.
     */
    function safeTransferFrom(
        address from,
        address to,
        uint256 id,
        uint256 amount,
        bytes calldata data
    ) external;

    /**
     * @dev xref:ROOT:erc1155.adoc#batch-operations[Batched] version of {safeTransferFrom}.
     *
     * Emits a {TransferBatch} event.
     *
     * Requirements:
     *
     * - `ids` and `amounts` must have the same length.
     * - If `to` refers to a smart contract, it must implement {IERC1155Receiver-onERC1155BatchReceived} and return the
     * acceptance magic value.
     */
    function safeBatchTransferFrom(
        address from,
        address to,
        uint256[] calldata ids,
        uint256[] calldata amounts,
        bytes calldata data
    ) external;
}

// SPDX-License-Identifier: MIT
// OpenZeppelin Contracts (last updated v4.6.0) (token/ERC1155/ERC1155.sol)

pragma solidity ^0.8.0;

import "./IERC1155.sol";
import "./IERC1155Receiver.sol";
import "./extensions/IERC1155MetadataURI.sol";
import "../../utils/Address.sol";
import "../../utils/Context.sol";
import "../../utils/introspection/ERC165.sol";

/**
 * @dev Implementation of the basic standard multi-token.
 * See https://eips.ethereum.org/EIPS/eip-1155
 * Originally based on code by Enjin: https://github.com/enjin/erc-1155
 *
 * _Available since v3.1._
 */
contract ERC1155 is Context, ERC165, IERC1155, IERC1155MetadataURI {
    using Address for address;

    // Mapping from token ID to account balances
    mapping(uint256 => mapping(address => uint256)) private _balances;

    // Mapping from account to operator approvals
    mapping(address => mapping(address => bool)) private _operatorApprovals;

    // Used as the URI for all token types by relying on ID substitution, e.g. https://token-cdn-domain/{id}.json
    string private _uri;

    /**
     * @dev See {_setURI}.
     */
    constructor(string memory uri_) {
        _setURI(uri_);
    }

    /**
     * @dev See {IERC165-supportsInterface}.
     */
    function supportsInterface(bytes4 interfaceId) public view virtual override(ERC165, IERC165) returns (bool) {
        return
            interfaceId == type(IERC1155).interfaceId ||
            interfaceId == type(IERC1155MetadataURI).interfaceId ||
            super.supportsInterface(interfaceId);
    }

    /**
     * @dev See {IERC1155MetadataURI-uri}.
     *
     * This implementation returns the same URI for *all* token types. It relies
     * on the token type ID substitution mechanism
     * https://eips.ethereum.org/EIPS/eip-1155#metadata[defined in the EIP].
     *
     * Clients calling this function must replace the `\{id\}` substring with the
     * actual token type ID.
     */
    function uri(uint256) public view virtual override returns (string memory) {
        return _uri;
    }

    /**
     * @dev See {IERC1155-balanceOf}.
     *
     * Requirements:
     *
     * - `account` cannot be the zero address.
     */
    function balanceOf(address account, uint256 id) public view virtual override returns (uint256) {
        require(account != address(0), "ERC1155: balance query for the zero address");
        return _balances[id][account];
    }

    /**
     * @dev See {IERC1155-balanceOfBatch}.
     *
     * Requirements:
     *
     * - `accounts` and `ids` must have the same length.
     */
    function balanceOfBatch(address[] memory accounts, uint256[] memory ids)
        public
        view
        virtual
        override
        returns (uint256[] memory)
    {
        require(accounts.length == ids.length, "ERC1155: accounts and ids length mismatch");

        uint256[] memory batchBalances = new uint256[](accounts.length);

        for (uint256 i = 0; i < accounts.length; ++i) {
            batchBalances[i] = balanceOf(accounts[i], ids[i]);
        }

        return batchBalances;
    }

    /**
     * @dev See {IERC1155-setApprovalForAll}.
     */
    function setApprovalForAll(address operator, bool approved) public virtual override {
        _setApprovalForAll(_msgSender(), operator, approved);
    }

    /**
     * @dev See {IERC1155-isApprovedForAll}.
     */
    function isApprovedForAll(address account, address operator) public view virtual override returns (bool) {
        return _operatorApprovals[account][operator];
    }

    /**
     * @dev See {IERC1155-safeTransferFrom}.
     */
    function safeTransferFrom(
        address from,
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) public virtual override {
        require(
            from == _msgSender() || isApprovedForAll(from, _msgSender()),
            "ERC1155: caller is not owner nor approved"
        );
        _safeTransferFrom(from, to, id, amount, data);
    }

    /**
     * @dev See {IERC1155-safeBatchTransferFrom}.
     */
    function safeBatchTransferFrom(
        address from,
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) public virtual override {
        require(
            from == _msgSender() || isApprovedForAll(from, _msgSender()),
            "ERC1155: transfer caller is not owner nor approved"
        );
        _safeBatchTransferFrom(from, to, ids, amounts, data);
    }

    /**
     * @dev Transfers `amount` tokens of token type `id` from `from` to `to`.
     *
     * Emits a {TransferSingle} event.
     *
     * Requirements:
     *
     * - `to` cannot be the zero address.
     * - `from` must have a balance of tokens of type `id` of at least `amount`.
     * - If `to` refers to a smart contract, it must implement {IERC1155Receiver-onERC1155Received} and return the
     * acceptance magic value.
     */
    function _safeTransferFrom(
        address from,
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) internal virtual {
        require(to != address(0), "ERC1155: transfer to the zero address");

        address operator = _msgSender();
        uint256[] memory ids = _asSingletonArray(id);
        uint256[] memory amounts = _asSingletonArray(amount);

        _beforeTokenTransfer(operator, from, to, ids, amounts, data);

        uint256 fromBalance = _balances[id][from];
        require(fromBalance >= amount, "ERC1155: insufficient balance for transfer");
        unchecked {
            _balances[id][from] = fromBalance - amount;
        }
        _balances[id][to] += amount;

        emit TransferSingle(operator, from, to, id, amount);

        _afterTokenTransfer(operator, from, to, ids, amounts, data);

        _doSafeTransferAcceptanceCheck(operator, from, to, id, amount, data);
    }

    /**
     * @dev xref:ROOT:erc1155.adoc#batch-operations[Batched] version of {_safeTransferFrom}.
     *
     * Emits a {TransferBatch} event.
     *
     * Requirements:
     *
     * - If `to` refers to a smart contract, it must implement {IERC1155Receiver-onERC1155BatchReceived} and return the
     * acceptance magic value.
     */
    function _safeBatchTransferFrom(
        address from,
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) internal virtual {
        require(ids.length == amounts.length, "ERC1155: ids and amounts length mismatch");
        require(to != address(0), "ERC1155: transfer to the zero address");

        address operator = _msgSender();

        _beforeTokenTransfer(operator, from, to, ids, amounts, data);

        for (uint256 i = 0; i < ids.length; ++i) {
            uint256 id = ids[i];
            uint256 amount = amounts[i];

            uint256 fromBalance = _balances[id][from];
            require(fromBalance >= amount, "ERC1155: insufficient balance for transfer");
            unchecked {
                _balances[id][from] = fromBalance - amount;
            }
            _balances[id][to] += amount;
        }

        emit TransferBatch(operator, from, to, ids, amounts);

        _afterTokenTransfer(operator, from, to, ids, amounts, data);

        _doSafeBatchTransferAcceptanceCheck(operator, from, to, ids, amounts, data);
    }

    /**
     * @dev Sets a new URI for all token types, by relying on the token type ID
     * substitution mechanism
     * https://eips.ethereum.org/EIPS/eip-1155#metadata[defined in the EIP].
     *
     * By this mechanism, any occurrence of the `\{id\}` substring in either the
     * URI or any of the amounts in the JSON file at said URI will be replaced by
     * clients with the token type ID.
     *
     * For example, the `https://token-cdn-domain/\{id\}.json` URI would be
     * interpreted by clients as
     * `https://token-cdn-domain/000000000000000000000000000000000000000000000000000000000004cce0.json`
     * for token type ID 0x4cce0.
     *
     * See {uri}.
     *
     * Because these URIs cannot be meaningfully represented by the {URI} event,
     * this function emits no events.
     */
    function _setURI(string memory newuri) internal virtual {
        _uri = newuri;
    }

    /**
     * @dev Creates `amount` tokens of token type `id`, and assigns them to `to`.
     *
     * Emits a {TransferSingle} event.
     *
     * Requirements:
     *
     * - `to` cannot be the zero address.
     * - If `to` refers to a smart contract, it must implement {IERC1155Receiver-onERC1155Received} and return the
     * acceptance magic value.
     */
    function _mint(
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) internal virtual {
        require(to != address(0), "ERC1155: mint to the zero address");

        address operator = _msgSender();
        uint256[] memory ids = _asSingletonArray(id);
        uint256[] memory amounts = _asSingletonArray(amount);

        _beforeTokenTransfer(operator, address(0), to, ids, amounts, data);

        _balances[id][to] += amount;
        emit TransferSingle(operator, address(0), to, id, amount);

        _afterTokenTransfer(operator, address(0), to, ids, amounts, data);

        _doSafeTransferAcceptanceCheck(operator, address(0), to, id, amount, data);
    }

    /**
     * @dev xref:ROOT:erc1155.adoc#batch-operations[Batched] version of {_mint}.
     *
     * Requirements:
     *
     * - `ids` and `amounts` must have the same length.
     * - If `to` refers to a smart contract, it must implement {IERC1155Receiver-onERC1155BatchReceived} and return the
     * acceptance magic value.
     */
    function _mintBatch(
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) internal virtual {
        require(to != address(0), "ERC1155: mint to the zero address");
        require(ids.length == amounts.length, "ERC1155: ids and amounts length mismatch");

        address operator = _msgSender();

        _beforeTokenTransfer(operator, address(0), to, ids, amounts, data);

        for (uint256 i = 0; i < ids.length; i++) {
            _balances[ids[i]][to] += amounts[i];
        }

        emit TransferBatch(operator, address(0), to, ids, amounts);

        _afterTokenTransfer(operator, address(0), to, ids, amounts, data);

        _doSafeBatchTransferAcceptanceCheck(operator, address(0), to, ids, amounts, data);
    }

    /**
     * @dev Destroys `amount` tokens of token type `id` from `from`
     *
     * Requirements:
     *
     * - `from` cannot be the zero address.
     * - `from` must have at least `amount` tokens of token type `id`.
     */
    function _burn(
        address from,
        uint256 id,
        uint256 amount
    ) internal virtual {
        require(from != address(0), "ERC1155: burn from the zero address");

        address operator = _msgSender();
        uint256[] memory ids = _asSingletonArray(id);
        uint256[] memory amounts = _asSingletonArray(amount);

        _beforeTokenTransfer(operator, from, address(0), ids, amounts, "");

        uint256 fromBalance = _balances[id][from];
        require(fromBalance >= amount, "ERC1155: burn amount exceeds balance");
        unchecked {
            _balances[id][from] = fromBalance - amount;
        }

        emit TransferSingle(operator, from, address(0), id, amount);

        _afterTokenTransfer(operator, from, address(0), ids, amounts, "");
    }

    /**
     * @dev xref:ROOT:erc1155.adoc#batch-operations[Batched] version of {_burn}.
     *
     * Requirements:
     *
     * - `ids` and `amounts` must have the same length.
     */
    function _burnBatch(
        address from,
        uint256[] memory ids,
        uint256[] memory amounts
    ) internal virtual {
        require(from != address(0), "ERC1155: burn from the zero address");
        require(ids.length == amounts.length, "ERC1155: ids and amounts length mismatch");

        address operator = _msgSender();

        _beforeTokenTransfer(operator, from, address(0), ids, amounts, "");

        for (uint256 i = 0; i < ids.length; i++) {
            uint256 id = ids[i];
            uint256 amount = amounts[i];

            uint256 fromBalance = _balances[id][from];
            require(fromBalance >= amount, "ERC1155: burn amount exceeds balance");
            unchecked {
                _balances[id][from] = fromBalance - amount;
            }
        }

        emit TransferBatch(operator, from, address(0), ids, amounts);

        _afterTokenTransfer(operator, from, address(0), ids, amounts, "");
    }

    /**
     * @dev Approve `operator` to operate on all of `owner` tokens
     *
     * Emits a {ApprovalForAll} event.
     */
    function _setApprovalForAll(
        address owner,
        address operator,
        bool approved
    ) internal virtual {
        require(owner != operator, "ERC1155: setting approval status for self");
        _operatorApprovals[owner][operator] = approved;
        emit ApprovalForAll(owner, operator, approved);
    }

    /**
     * @dev Hook that is called before any token transfer. This includes minting
     * and burning, as well as batched variants.
     *
     * The same hook is called on both single and batched variants. For single
     * transfers, the length of the `id` and `amount` arrays will be 1.
     *
     * Calling conditions (for each `id` and `amount` pair):
     *
     * - When `from` and `to` are both non-zero, `amount` of ``from``'s tokens
     * of token type `id` will be  transferred to `to`.
     * - When `from` is zero, `amount` tokens of token type `id` will be minted
     * for `to`.
     * - when `to` is zero, `amount` of ``from``'s tokens of token type `id`
     * will be burned.
     * - `from` and `to` are never both zero.
     * - `ids` and `amounts` have the same, non-zero length.
     *
     * To learn more about hooks, head to xref:ROOT:extending-contracts.adoc#using-hooks[Using Hooks].
     */
    function _beforeTokenTransfer(
        address operator,
        address from,
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) internal virtual {}

    /**
     * @dev Hook that is called after any token transfer. This includes minting
     * and burning, as well as batched variants.
     *
     * The same hook is called on both single and batched variants. For single
     * transfers, the length of the `id` and `amount` arrays will be 1.
     *
     * Calling conditions (for each `id` and `amount` pair):
     *
     * - When `from` and `to` are both non-zero, `amount` of ``from``'s tokens
     * of token type `id` will be  transferred to `to`.
     * - When `from` is zero, `amount` tokens of token type `id` will be minted
     * for `to`.
     * - when `to` is zero, `amount` of ``from``'s tokens of token type `id`
     * will be burned.
     * - `from` and `to` are never both zero.
     * - `ids` and `amounts` have the same, non-zero length.
     *
     * To learn more about hooks, head to xref:ROOT:extending-contracts.adoc#using-hooks[Using Hooks].
     */
    function _afterTokenTransfer(
        address operator,
        address from,
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) internal virtual {}

    function _doSafeTransferAcceptanceCheck(
        address operator,
        address from,
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) private {
        if (to.isContract()) {
            try IERC1155Receiver(to).onERC1155Received(operator, from, id, amount, data) returns (bytes4 response) {
                if (response != IERC1155Receiver.onERC1155Received.selector) {
                    revert("ERC1155: ERC1155Receiver rejected tokens");
                }
            } catch Error(string memory reason) {
                revert(reason);
            } catch {
                revert("ERC1155: transfer to non ERC1155Receiver implementer");
            }
        }
    }

    function _doSafeBatchTransferAcceptanceCheck(
        address operator,
        address from,
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) private {
        if (to.isContract()) {
            try IERC1155Receiver(to).onERC1155BatchReceived(operator, from, ids, amounts, data) returns (
                bytes4 response
            ) {
                if (response != IERC1155Receiver.onERC1155BatchReceived.selector) {
                    revert("ERC1155: ERC1155Receiver rejected tokens");
                }
            } catch Error(string memory reason) {
                revert(reason);
            } catch {
                revert("ERC1155: transfer to non ERC1155Receiver implementer");
            }
        }
    }

    function _asSingletonArray(uint256 element) private pure returns (uint256[] memory) {
        uint256[] memory array = new uint256[](1);
        array[0] = element;

        return array;
    }
}